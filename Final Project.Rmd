---
title: "NFL Stats"
author: "Anirudh Kamath and Nikita Jethani"
date: "3/24/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(RSQLite)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
clean_basic_stats <- function(basic_stats) {
  # Clean the experience - "1st season"/"Rookie" should equate to 0 seasons, and things like "8th season" or "3rd season" should     equate to 7 and 2 seasons respectively. 
  basic_stats['experience'] <- basic_stats['experience'] %>%
    sapply(tolower) %>%
    sapply(function(x) {x %>% str_replace_all('1st', '0')}) %>%
    sapply(function(x) {x %>% str_replace_all('rookie', '0')}) %>%
    sapply(function(x) {x %>% str_replace_all('first', '0')}) %>%
    sapply(function(x) {x %>% str_replace('season', '')}) %>%
    sapply(function(x) {gsub("^\\s+|\\s+$", "", x)}) %>%
    sapply(function(x) {
      if(is.na(x)) {return(x)}
      if(str_detect(x, ' s')) {
        return(x %>% str_replace(' s', '') %>% as.numeric())
      }
      else {
        tor <- x %>% str_replace("\\D*(\\d+).*", "\\1") %>% as.numeric()
        if(!is.na(tor) && tor > 1) {return(tor - 1)}
        return(tor)
      }
    }) %>%
    as.numeric()
  
  # We only want active players, and we want to separate their birth place (city, state) into two columns. Same with their names
  basic_stats <- basic_stats %>%
    filter(current_status == 'Active') %>%
    separate(birth_place, into = c("birth_city", "birth_state"), sep = " , ") %>%
    separate(name, into = c("last_name", "first_name"), sep = ", ")
  return(basic_stats)
}

# Remove spaces in column names and replace periods with underscores so it's easier to read in SQL
clean_columns <- function(df, db, include_name_year) {
  name <- str_replace(df, '.csv', '') %>% str_to_lower()
  name <- str_replace(name, './', '') 
  df <- read.csv(df)
  df[df=="--"]<-NA
  oldnames <- names(df)
  newnames <- oldnames %>%
      sapply(tolower) %>%
      sapply(function(x) {gsub('\\.$', '', x)}) %>%
      sapply(function(x) {gsub('(\\.)\\1+', '_', x)}) %>%
      sapply(function(x) {gsub('\\.', '_', x)})
  df <- df %>% rename_at(vars(oldnames), ~ newnames)
  if(name == 'basic_stats') {
    df <- clean_basic_stats(df)
  }
  if(missing(include_name_year)) {
    df <- df %>% select(-name, -position)
  }
  dbWriteTable(conn = db, name = name, value = df, row.names = FALSE, header = TRUE)
  return(df)
}

db <- dbConnect(SQLite(), dbname="nfl.sqlite")
files <- list.files(pattern="*csv", full.names=TRUE, recursive=FALSE)
for(file in files) {
  if (file %>% str_detect('Basic_Stats')) {
    clean_columns(file, db, T)
  }
  else {
    clean_columns(file, db)
  }
}

dbListTables(db)
```

```{r}
basics <- dbGetQuery(db, 'select * from basic_stats')
basics[,'fantasy_score'] <- 0
```

```{r}
# Let's rank players based on their passing abilities
updateScore <- function(df, newdf) {
   temp <- df %>%
    select(player_id, fantasy_score) %>%
    inner_join(newdf, by='player_id')
  temp$fantasy_score <- temp$fantasy_score + temp$points 
  temp <- temp %>% select(player_id, fantasy_score)
  df <- df %>% left_join(temp, by='player_id', suffix=c('_old', '')) %>% select(-fantasy_score_old) 
  return(df)
}

passers <- dbGetQuery(db, paste("select first_name, last_name, basic_stats.player_id, year, team, ",
  "(passes_attempted * passing_yards_per_attempt * completion_percentage +",
  "4 * td_passes * percentage_of_tds_per_attempts +",
  "2 * passes_longer_than_20_yards * completion_percentage -",
  "2 * ints * int_rate)/(100 * games_played) as points",
  "from career_stats_passing",
  "join basic_stats on basic_stats.player_id=career_stats_passing.player_id",
  "where year = 2016",
  "order by points desc"))
basics <- basics %>% updateScore(passers) %>% arrange(desc(fantasy_score))
basics
```



```{r}
# Let's do rushing now
rushers <- dbGetQuery(db, paste("select first_name, last_name, basic_stats.player_id, year, team, ",
  "(60 * rushing_tds + rushing_yards)/(10 * games_played) as points",
  "from career_stats_rushing",
  "join basic_stats on basic_stats.player_id=career_stats_rushing.player_id",
  "where year = 2016",
  "order by points desc"))
basics <- basics %>% updateScore(rushers) %>% arrange(desc(fantasy_score))
basics
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.